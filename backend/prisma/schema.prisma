generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int          @id @default(autoincrement())
  username      String       @unique @db.VarChar(50)
  email         String       @unique @db.VarChar(100)
  passwordHash  String       @db.VarChar(255)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  habits        Habit[]
  completions   Completion[]
  followers     Follow[]     @relation("Following")
  following     Follow[]     @relation("Followers")
  integrations  Integration[]

  resetPasswordToken   String?  @db.VarChar(255)
  resetPasswordExpires DateTime?

  @@index([username])
  @@index([email])
}

model Habit {
  id          Int          @id @default(autoincrement())
  userId      Int
  name        String       @db.VarChar(100)
  description String?      @db.Text
  frequency   Frequency    @default(DAILY)
  category    Category     @default(OTHER)
  color       String?      @db.VarChar(7)
  icon        String?      @db.VarChar(50)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  completions Completion[]

  @@unique([userId, name])
  @@index([userId])
  @@index([category])
}

model Completion {
  id          Int      @id @default(autoincrement())
  habitId     Int
  userId      Int
  completedAt DateTime @default(now())
  notes       String?  @db.Text
  
  habit       Habit    @relation(fields: [habitId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([habitId, completedAt])
  @@index([habitId])
  @@index([userId])
  @@index([completedAt])
}

model Follow {
  id          Int      @id @default(autoincrement())
  followerId  Int
  followingId Int
  createdAt   DateTime @default(now())
  
  follower    User     @relation("Followers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

enum Frequency {
  DAILY
  WEEKLY
}

enum Category {
  HEALTH
  FITNESS
  PRODUCTIVITY
  LEARNING
  MINDFULNESS
  NUTRITION
  SOCIAL
  FINANCE
  CREATIVITY
  OTHER
}

model Integration {
  id            Int      @id @default(autoincrement())
  userId        Int
  provider      Provider
  accessToken   String   @db.Text
  refreshToken  String?  @db.Text
  expiresAt     DateTime?
  metadata      Json?    // For storing extra info like Notion workspace name or Spotify profile
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId])
}

enum Provider {
  SPOTIFY
  NOTION
}
